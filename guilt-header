#!/bin/sh
#
# Copyright (c) Josef "Jeff" Sipek, 2006, 2007
#

USAGE="[-e] [<patchname>]"
. `dirname $0`/guilt

case $# in
	0)
		patch=`get_top`
		;;
	1)
		if [ "$1" = "-e" ]; then
			edit=t
			patch=`get_top`
		else
			patch="$1"
		fi
		;;
	2)
		[ "$1" != "-e" ] && usage

		edit=t
		patch="$2"

		;;
esac

# are there any patches applied?
[ -z "$patch" ] && die "No patches applied."

# check that patch exists in the series
ret=`get_series | grep -ne "^$patch\$" | cut -d: -f1`
if [ $ret -eq 0 ]; then
	die "Patch $patch is not in the series"
fi

# FIXME: warn if we're editing an applied patch

if [ -z "$edit" ]; then
	do_get_header "$GUILT_DIR/$branch/$patch"
else
	do_get_full_header "$GUILT_DIR/$branch/$patch" > /tmp/guilt.msg.$$
	do_get_patch "$GUILT_DIR/$branch/$patch" > /tmp/guilt.diff.$$
	$editor "/tmp/guilt.msg.$$"
	mv "$GUILT_DIR/$branch/$patch" "$GUILT_DIR/$branch/$patch~"

	(
		cat /tmp/guilt.msg.$$
		cat /tmp/guilt.diff.$$
	) > "$GUILT_DIR/$branch/$patch"
fi
